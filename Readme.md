# üõ°Ô∏è AWS Secure Cloud Lab ‚Äì DevSecOps Pipeline

## üìñ Project Overview

This project implements a secure, automated **Infrastructure as Code (IaC)** pipeline using **Terraform** and **GitHub Actions**. It is designed to demonstrate a robust **DevSecOps** workflow where security controls are integrated into every stage of the infrastructure lifecycle.

The architecture supports a **multi-environment strategy** (Development & Production) managed via a Monorepo structure, ensuring strict separation of state and configuration.

### üöÄ Key Features

- **Multi-Environment Deployment:** Isolated environments for `dev` and `prod` with separate state files.
- **Shift-Left Security:** Automated scanning for code quality (TFLint), secrets (TruffleHog), and misconfigurations (Checkov) before deployment.
- **Secure Authentication:** **OpenID Connect (OIDC)** federation eliminates long-lived AWS Access Keys in CI/CD.
- **State Management:** Remote state stored in S3 (encrypted) with DynamoDB locking to prevent race conditions.
- **Cost Management:** Automated "Destroy" workflows to decommission Lab resources and prevent billing leakage.

---

## üõ†Ô∏è Pipeline Architecture

The CI/CD pipeline enforces a "Security Gate" approach. Code is only deployed if it passes all scans.

```mermaid
graph TD
    User[Developer] -->|Push| GitHub[GitHub Repo]
    subgraph CI_Process [Continuous Integration]
        GitHub -->|Trigger| TFLint[Static Analysis (TFLint)]
        TFLint -->|Pass| TruffleHog[Secret Scanning (TruffleHog)]
        TruffleHog -->|Pass| Checkov[IaC Security (Checkov)]
    end

    subgraph CD_Process [Continuous Deployment]
        Checkov -->|Pass| Auth[AWS OIDC Auth]
        Auth --> Plan[Terraform Plan]
        Plan -->|Branch = Main| Apply[Terraform Apply]
    end

    subgraph Operations
        User -->|Manual Trigger| Destroy[Terraform Destroy]
    end

    Apply --> AWS[AWS Cloud (S3/EC2)]
    Destroy -->|Cleanup| AWS

```

---

## üìÇ Repository Structure

The project follows a Monorepo pattern to manage multiple environments efficiently.

```text
.
‚îú‚îÄ‚îÄ .github/workflows/
‚îÇ   ‚îú‚îÄ‚îÄ terraform-dev.yaml     # CI/CD for Development (Plan & Apply)
‚îÇ   ‚îú‚îÄ‚îÄ terraform-prod.yaml    # CI/CD for Production (Plan & Apply)
‚îÇ   ‚îî‚îÄ‚îÄ terraform-destroy.yaml # Manual Workflow to destroy Dev resources
‚îú‚îÄ‚îÄ secure-cloud-lab-dev/      # Development Environment Code
‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îî‚îÄ‚îÄ .tflint.hcl
‚îú‚îÄ‚îÄ secure-cloud-lab-prod/     # Production Environment Code
‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îî‚îÄ‚îÄ .tflint.hcl
‚îî‚îÄ‚îÄ README.md

```

---

## üîí Security Measures (DevSecOps)

### 1. Identity & Access Management (IAM)

- **OIDC Federation:** The pipeline authenticates via a temporary token generated by GitHub, exchanged for AWS credentials. No hardcoded secrets exist in the repository.
- **Least Privilege:** The CI/CD IAM Role has a Trust Policy scoped strictly to this specific GitHub repository.

### 2. Automated Scanning Tools

- **TFLint:** Enforces valid Terraform syntax and cloud-provider rules (e.g., valid instance types).
- **TruffleHog:** Deep scans the git history (`fetch-depth: 0`) to detect leaked API keys or passwords.
- **Checkov:** Audits infrastructure against CIS Benchmarks.
- _Implementation:_ Blocking deployment on critical failures.
- _Risk Acceptance:_ Documented waivers for non-critical lab rules using `# checkov:skip` annotations (e.g., skipping KMS encryption to save costs).

### 3. Data Protection

- **S3 Hardening:** Buckets are configured with Versioning (enforced by Checkov) and Public Access Blocks.
- **State Locking:** Utilizes DynamoDB to prevent concurrent state corruption during team collaboration.

---

## üíª CI/CD Workflows

### üü¢ `Terraform Dev/Prod Pipeline`

- **Trigger:** Push to `main` (filtered by directory path).
- **Steps:** Checkout -> Security Scans -> OIDC Auth -> Terraform Plan -> Terraform Apply (Auto-Approve).

### üî¥ `Terraform Destroy (Manual)`

- **Trigger:** Manual (`workflow_dispatch`).
- **Purpose:** Cost optimization. Allows for a one-click teardown of the environment after testing is complete.

---

## üìù Engineering Challenges & Solutions

During the development of this pipeline, several technical challenges were addressed:

1. **OIDC Thumbprint Mismatch:**

- _Issue:_ Authentication failed with `Invalid Identity Token`.
- _Solution:_ Manually updated the AWS IAM Identity Provider with the correct GitHub certificate thumbprints via AWS CLI.

2. **Shallow Clone vs. Secret Scanning:**

- _Issue:_ TruffleHog passed immediately without scanning history.
- _Solution:_ Configured `actions/checkout` with `fetch-depth: 0` to ensure deep historical analysis.

3. **State Locking Warning:**

- _Observation:_ Terraform warned about `dynamodb_table` being deprecated in favor of S3 native locking.
- _Decision:_ Retained DynamoDB to demonstrate knowledge of classic High Availability state management patterns widely used in enterprise environments.

4. **Backend Separation:**

- _Strategy:_ Implemented strict backend key isolation (`dev/terraform.tfstate` vs `prod/terraform.tfstate`) to allow the same S3 bucket to serve multiple environments without conflict.

---

**Author:** Filip
**License:** MIT
